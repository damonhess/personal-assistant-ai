{
  "name": "Advanced - Context Summarizer",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        420,
        220
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Get long conversations for summarization\nSELECT \n  session_id,\n  COUNT(*) as message_count,\n  MIN(timestamp) as conversation_start,\n  MAX(timestamp) as conversation_end,\n  json_agg(\n    json_build_object(\n      'role', role,\n      'message', message,\n      'timestamp', timestamp\n    ) ORDER BY timestamp\n  ) as messages\nFROM conversations\nWHERE timestamp >= NOW() - INTERVAL '24 hours'\nGROUP BY session_id\nHAVING COUNT(*) > 20\nORDER BY MAX(timestamp) DESC\nLIMIT 5;"
      },
      "id": "find-long-conversations",
      "name": "Find Long Conversations",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        420,
        460
      ],
      "credentials": {
        "postgres": {
          "id": "supabase-credential",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare conversation for LangChain Document\nconst conversation = $input.item.json;\n\n// Format as structured document\nconst conversationText = conversation.messages\n  .map((m, idx) => {\n    const timestamp = new Date(m.timestamp).toLocaleTimeString();\n    const content = typeof m.message === 'object' ? JSON.stringify(m.message) : m.message;\n    return `[${timestamp}] ${m.role}: ${content}`;\n  })\n  .join('\\n\\n');\n\nconst metadata = {\n  session_id: conversation.session_id,\n  message_count: conversation.message_count,\n  conversation_start: conversation.conversation_start,\n  conversation_end: conversation.conversation_end,\n  duration_hours: Math.round(\n    (new Date(conversation.conversation_end) - new Date(conversation.conversation_start)) / 3600000\n  )\n};\n\nreturn {\n  json: {\n    pageContent: conversationText,\n    metadata: metadata\n  }\n};"
      },
      "id": "prepare-document",
      "name": "Prepare Document",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        420,
        700
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.pageContent }}",
        "options": {
          "systemMessage": "You are an expert conversation analyst. Create a comprehensive yet concise summary of this conversation.\n\n## Summary Structure\n\n**Key Decisions Made:**\n- List any decisions, choices, or commitments\n\n**Tasks & Action Items:**\n- Concrete tasks mentioned or created\n- Deadlines if specified\n\n**Important Context:**\n- Main topics discussed\n- Problems identified\n- Solutions proposed\n\n**Outcomes:**\n- What was accomplished\n- Next steps identified\n\n**Patterns Observed:**\n- Recurring themes\n- Notable insights\n\nBe specific and actionable. Focus on information that would be useful to reference later."
        }
      },
      "id": "summarization-chain",
      "name": "Summarization Chain",
      "type": "@n8n/n8n-nodes-langchain.chainSummarization",
      "typeVersion": 2,
      "position": [
        420,
        940
      ]
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.3,
          "maxTokens": 600
        }
      },
      "id": "openai-model-summarizer",
      "name": "OpenAI Chat Model (Summarizer)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        600,
        940
      ],
      "credentials": {
        "openAiApi": {
          "id": "openai-credential",
          "name": "OpenAI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract summary and add metadata\nconst summary = $input.item.json.response;\nconst metadata = JSON.parse($('Prepare Document').item.json.metadata || '{}');\n\nreturn {\n  json: {\n    session_id: metadata.session_id,\n    message_count: metadata.message_count,\n    conversation_start: metadata.conversation_start,\n    conversation_end: metadata.conversation_end,\n    duration_hours: metadata.duration_hours,\n    summary: summary,\n    summarized_at: new Date().toISOString()\n  }\n};"
      },
      "id": "format-summary",
      "name": "Format Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        420,
        1180
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Store summary as a conversation record with structured format\nINSERT INTO conversations (session_id, message, role, metadata)\nVALUES (\n  '{{ $json.session_id }}',\n  '{{ JSON.stringify({ type: 'summary', content: $json.summary }) }}'::jsonb,\n  'system',\n  '{{ JSON.stringify({ \n    original_message_count: $json.message_count, \n    conversation_start: $json.conversation_start,\n    conversation_end: $json.conversation_end,\n    duration_hours: $json.duration_hours,\n    summarized_at: $json.summarized_at,\n    summarization_method: 'langchain_refine'\n  }) }}'::jsonb\n)\nRETURNING id, session_id, timestamp;"
      },
      "id": "store-summary",
      "name": "Store Summary",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        420,
        1420
      ],
      "credentials": {
        "postgres": {
          "id": "supabase-credential",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Optionally: Delete old messages after summarization to save space\n-- (Commented out for safety - enable if desired)\n-- DELETE FROM conversations\n-- WHERE session_id = '{{ $('Format Summary').item.json.session_id }}'\n--   AND role != 'system'\n--   AND timestamp < '{{ $('Format Summary').item.json.conversation_end }}'\n-- RETURNING COUNT(*) as deleted_count;\n\nSELECT '{{ $('Format Summary').item.json.session_id }}' as session_id, 0 as deleted_count;"
      },
      "id": "cleanup-old-messages",
      "name": "Cleanup Old Messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        420,
        1660
      ],
      "credentials": {
        "postgres": {
          "id": "supabase-credential",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "content": "## ðŸ“ Context Summarizer (LangChain)\n\n**Architecture**: LangChain Summarization Chain\n**Method**: Refine (most sophisticated)\n**Model**: GPT-4o-mini (temp: 0.3)\n\n**Runs**: Every 12 hours\n\n**Triggers When**:\n- Conversation >20 messages\n- Within last 24 hours\n\n**LangChain Advantages**:\nâœ“ Advanced chunking strategies\nâœ“ Refine method for iterative improvement\nâœ“ Better handling of long conversations\nâœ“ Structured summary format\nâœ“ Preserves important details\n\n**Summary Structure**:\n1. Key Decisions Made\n2. Tasks & Action Items\n3. Important Context\n4. Outcomes\n5. Patterns Observed\n\n**Process**:\n1. Find long conversations (SQL)\n2. Prepare as LangChain Document\n3. LangChain Summarization Chain\n   - Chunks conversation intelligently\n   - Refines summary iteratively\n   - Maintains coherence\n4. Store as system message\n5. Optional: Cleanup old messages\n\n**Benefits**:\n- Reduces token usage 80-90%\n- Preserves conversation history\n- Structured, actionable summaries\n- Improves AI context efficiency\n- Better quality than simple API calls\n\n**Why Refine Method**:\n- Processes long text in chunks\n- Builds summary iteratively\n- Maintains context across chunks\n- Higher quality than Map-Reduce",
        "height": 1600,
        "width": 480,
        "color": 4
      },
      "id": "sticky-documentation",
      "name": "Agent Documentation",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        240,
        100
      ]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Find Long Conversations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Long Conversations": {
      "main": [
        [
          {
            "node": "Prepare Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Document": {
      "main": [
        [
          {
            "node": "Summarization Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarization Chain": {
      "main": [
        [
          {
            "node": "Format Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model (Summarizer)": {
      "ai_languageModel": [
        [
          {
            "node": "Summarization Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Format Summary": {
      "main": [
        [
          {
            "node": "Store Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Summary": {
      "main": [
        [
          {
            "node": "Cleanup Old Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    "advanced",
    "automation",
    "optimization",
    "langchain"
  ],
  "triggerCount": 0,
  "versionId": ""
}
